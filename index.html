<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>–ù–∞—à–∞ –°–µ–º—å—è</title>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#D4A574">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="#D4A574">
  <link rel="apple-touch-icon" href="icon-192.png">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    /* ===== RESET & BASE ===== */
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    html, body { height: 100%; overflow: hidden; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
      color: #3A2E28;
      background: linear-gradient(135deg, #FDF6F0 0%, #F5EDE4 50%, #EDE4DA 100%);
    }
    input, button, textarea { font-family: inherit; }
    .hidden { display: none !important; }

    /* ===== BACKGROUND PATTERN ===== */
    #bg-pattern {
      position: fixed; inset: 0; opacity: 0.03; pointer-events: none; z-index: 0;
      background-image: radial-gradient(circle at 20px 20px, #8B7355 1px, transparent 1px);
      background-size: 40px 40px;
    }

    /* ===== SCREENS ===== */
    .screen {
      position: fixed; inset: 0; z-index: 1;
      display: flex; align-items: center; justify-content: center;
    }

    /* ===== LOGIN SCREEN ===== */
    .login-card {
      background: rgba(255,255,255,0.75); backdrop-filter: blur(24px);
      border-radius: 28px; padding: 48px 36px; width: 90%; max-width: 380px;
      box-shadow: 0 20px 60px rgba(139,115,85,0.12);
      text-align: center;
      animation: cardAppear 0.5s ease;
    }
    .login-logo {
      width: 80px; height: 80px; border-radius: 24px; margin: 0 auto 20px;
      background: linear-gradient(135deg, #D4A574, #C4956A);
      display: flex; align-items: center; justify-content: center;
      font-size: 40px; box-shadow: 0 8px 24px rgba(196,149,106,0.3);
    }
    .login-title { font-size: 22px; font-weight: 700; color: #5C4A3A; margin-bottom: 6px; }
    .login-subtitle { font-size: 14px; color: #A08B78; margin-bottom: 28px; }
    .form-input {
      width: 100%; padding: 14px 18px; border-radius: 14px; border: 1.5px solid rgba(168,144,120,0.2);
      background: rgba(255,255,255,0.8); font-size: 15px; color: #4A3C32;
      outline: none; margin-bottom: 12px; transition: border-color 0.2s;
    }
    .form-input:focus { border-color: rgba(212,165,116,0.5); }
    .form-input::placeholder { color: #B8A596; }
    .btn-primary {
      width: 100%; padding: 14px; border-radius: 14px; border: none;
      background: linear-gradient(135deg, #D4A574, #C4956A); color: #fff;
      font-size: 16px; font-weight: 600; cursor: pointer;
      box-shadow: 0 4px 16px rgba(196,149,106,0.3); transition: all 0.2s;
      margin-top: 4px;
    }
    .btn-primary:hover { transform: translateY(-1px); box-shadow: 0 6px 20px rgba(196,149,106,0.4); }
    .btn-primary:active { transform: translateY(0); }
    .btn-primary:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }
    .error-msg {
      background: rgba(200,100,100,0.1); color: #C86464; padding: 10px 14px;
      border-radius: 10px; font-size: 13px; margin-bottom: 12px;
    }

    /* ===== PROFILE SETUP ===== */
    .emoji-grid {
      display: flex; flex-wrap: wrap; gap: 8px; justify-content: center;
      margin: 12px 0 16px;
    }
    .emoji-option {
      width: 48px; height: 48px; border-radius: 14px; border: 2px solid transparent;
      background: rgba(255,255,255,0.6); display: flex; align-items: center;
      justify-content: center; font-size: 24px; cursor: pointer; transition: all 0.2s;
    }
    .emoji-option:hover { background: rgba(212,165,116,0.1); }
    .emoji-option.selected { border-color: #D4A574; background: rgba(212,165,116,0.15); }
    .color-grid {
      display: flex; flex-wrap: wrap; gap: 8px; justify-content: center;
      margin: 12px 0 16px;
    }
    .color-option {
      width: 36px; height: 36px; border-radius: 50%; cursor: pointer;
      border: 3px solid transparent; transition: all 0.2s;
    }
    .color-option:hover { transform: scale(1.15); }
    .color-option.selected { border-color: #5C4A3A; }
    .section-label { font-size: 14px; color: #8B7355; font-weight: 600; margin-top: 8px; }

    /* ===== MESSENGER LAYOUT ===== */
    #messenger-screen {
      display: flex; align-items: stretch; justify-content: stretch;
    }

    /* Sidebar */
    #sidebar {
      width: 320px; min-width: 320px; display: flex; flex-direction: column;
      background: rgba(255,255,255,0.65); backdrop-filter: blur(20px);
      border-right: 1px solid rgba(168,144,120,0.15); z-index: 2;
    }
    .sidebar-header {
      padding: 20px 16px 14px; border-bottom: 1px solid rgba(168,144,120,0.1);
      display: flex; align-items: center; gap: 12px;
    }
    .sidebar-logo {
      width: 42px; height: 42px; border-radius: 14px;
      background: linear-gradient(135deg, #D4A574, #C4956A);
      display: flex; align-items: center; justify-content: center;
      font-size: 20px; box-shadow: 0 4px 12px rgba(196,149,106,0.3); flex-shrink: 0;
    }
    .sidebar-title { font-size: 17px; font-weight: 700; color: #5C4A3A; }
    .sidebar-meta { font-size: 12px; color: #A08B78; margin-top: 1px; }
    .sidebar-actions { margin-left: auto; }
    .btn-icon {
      width: 36px; height: 36px; border-radius: 10px; border: none;
      background: rgba(212,165,116,0.1); cursor: pointer; font-size: 16px;
      display: flex; align-items: center; justify-content: center; transition: all 0.2s;
    }
    .btn-icon:hover { background: rgba(212,165,116,0.2); }

    /* Conversation list */
    #conv-list { flex: 1; overflow-y: auto; padding: 6px; }
    .conv-section-title {
      padding: 10px 14px 4px; font-size: 11px; font-weight: 700;
      color: #B8A596; text-transform: uppercase; letter-spacing: 0.5px;
    }
    .conv-item {
      display: flex; align-items: center; gap: 12px;
      padding: 12px 14px; border-radius: 16px; cursor: pointer;
      transition: background 0.15s; margin-bottom: 1px;
    }
    .conv-item:hover { background: rgba(212,165,116,0.08); }
    .conv-item.active { background: rgba(212,165,116,0.15); }
    .conv-avatar {
      width: 46px; height: 46px; border-radius: 15px;
      display: flex; align-items: center; justify-content: center;
      font-size: 22px; flex-shrink: 0;
    }
    .conv-info { flex: 1; min-width: 0; }
    .conv-name { font-weight: 600; font-size: 14.5px; color: #4A3C32; }
    .conv-last-msg {
      font-size: 13px; color: #9A8878; margin-top: 2px;
      white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
    }
    .conv-city {
      font-size: 11px; color: #C4A882; margin-top: 2px;
      display: flex; align-items: center; gap: 4px;
    }
    .conv-time { font-size: 11px; color: #B8A596; white-space: nowrap; align-self: flex-start; margin-top: 2px; }
    .online-dot {
      width: 6px; height: 6px; border-radius: 50%;
      background: #8BC49E; display: inline-block;
    }

    /* My profile (sidebar footer) */
    .sidebar-footer {
      padding: 14px 16px; border-top: 1px solid rgba(168,144,120,0.1);
      display: flex; align-items: center; gap: 10px;
    }
    .my-avatar {
      width: 36px; height: 36px; border-radius: 12px;
      display: flex; align-items: center; justify-content: center; font-size: 18px;
    }
    .my-name { font-size: 14px; font-weight: 600; color: #4A3C32; }
    .my-city { font-size: 11px; color: #A08B78; }
    .btn-logout {
      margin-left: auto; font-size: 12px; color: #B8A596;
      background: none; border: none; cursor: pointer; padding: 6px 10px;
      border-radius: 8px; transition: all 0.2s;
    }
    .btn-logout:hover { background: rgba(200,100,100,0.08); color: #C86464; }

    /* ===== NOTIFICATION BANNER ===== */
    .notification-banner {
      padding: 10px 14px; background: rgba(212,165,116,0.15);
      border-bottom: 1px solid rgba(168,144,120,0.1);
      display: flex; align-items: center; gap: 10px; font-size: 13px;
    }
    .notification-banner button {
      padding: 6px 12px; border-radius: 8px; border: none;
      background: linear-gradient(135deg, #D4A574, #C4956A);
      color: white; font-size: 12px; font-weight: 600; cursor: pointer;
    }
    .notification-banner .dismiss {
      background: transparent; color: #A08B78; margin-left: auto;
    }

    /* ===== CHAT AREA ===== */
    #chat-area {
      flex: 1; display: flex; flex-direction: column; position: relative; z-index: 1;
    }

    /* Chat header */
    .chat-header {
      padding: 14px 18px; display: flex; align-items: center; gap: 12px;
      background: rgba(255,255,255,0.5); backdrop-filter: blur(20px);
      border-bottom: 1px solid rgba(168,144,120,0.1);
    }
    .btn-back {
      display: none; background: none; border: none; cursor: pointer;
      font-size: 20px; color: #8B7355; padding: 4px;
    }
    .chat-header-avatar {
      width: 40px; height: 40px; border-radius: 13px;
      display: flex; align-items: center; justify-content: center; font-size: 20px;
    }
    .chat-header-name { font-weight: 600; font-size: 15px; color: #4A3C32; }
    .chat-header-status { font-size: 12px; color: #8BC49E; display: flex; align-items: center; gap: 4px; }
    .chat-header-members { font-size: 12px; color: #A08B78; }

    /* Refresh button */
    .btn-refresh {
      width: 36px; height: 36px; border-radius: 10px; border: none;
      background: rgba(212,165,116,0.1); cursor: pointer; font-size: 16px;
      display: flex; align-items: center; justify-content: center; transition: all 0.2s;
      margin-left: auto;
    }
    .btn-refresh:hover { background: rgba(212,165,116,0.2); }
    .btn-refresh:disabled { opacity: 0.5; cursor: not-allowed; }
    .btn-refresh.spinning { animation: spin 0.6s linear infinite; }

    /* Messages */
    #messages-container {
      flex: 1; overflow-y: auto; padding: 16px; display: flex;
      flex-direction: column; gap: 6px;
    }
    .msg-row { display: flex; animation: msgPop 0.25s ease; }
    .msg-row.me { justify-content: flex-end; }
    .msg-row.other { justify-content: flex-start; }
    .msg-bubble {
      max-width: 75%; padding: 10px 14px; line-height: 1.5; font-size: 14.5px;
      word-wrap: break-word;
    }
    .msg-row.me .msg-bubble {
      border-radius: 18px 18px 5px 18px;
      background: linear-gradient(135deg, #D4A574, #C4956A);
      color: #fff; box-shadow: 0 2px 10px rgba(196,149,106,0.2);
    }
    .msg-row.other .msg-bubble {
      border-radius: 18px 18px 18px 5px;
      background: rgba(255,255,255,0.85);
      color: #4A3C32; box-shadow: 0 2px 6px rgba(0,0,0,0.04);
    }
    .msg-sender {
      font-size: 12px; font-weight: 600; margin-bottom: 3px; opacity: 0.75;
    }
    .msg-image {
      border-radius: 12px; max-width: 260px; width: 100%; display: block;
      cursor: pointer; margin-bottom: 4px;
    }
    .msg-text { white-space: pre-wrap; }
    .msg-time { font-size: 11px; opacity: 0.55; text-align: right; margin-top: 3px; }
    .msg-date-divider {
      text-align: center; font-size: 12px; color: #B8A596;
      padding: 8px 0; font-weight: 500;
    }

    /* Photo preview */
    #photo-preview {
      padding: 8px 16px; background: rgba(255,255,255,0.7);
      display: none; align-items: center; gap: 10px;
    }
    #photo-preview.visible { display: flex; }
    #photo-preview img { width: 56px; height: 56px; object-fit: cover; border-radius: 10px; }
    .btn-remove-photo {
      background: rgba(200,100,100,0.12); border: none; border-radius: 8px;
      padding: 4px 12px; cursor: pointer; color: #C86464; font-size: 13px;
    }

    /* Input area */
    .chat-input-area {
      padding: 12px 14px; display: flex; align-items: center; gap: 8px;
      background: rgba(255,255,255,0.6); backdrop-filter: blur(20px);
      border-top: 1px solid rgba(168,144,120,0.1);
    }
    .btn-photo {
      width: 40px; height: 40px; border-radius: 12px; border: none;
      background: rgba(212,165,116,0.12); cursor: pointer; font-size: 18px;
      display: flex; align-items: center; justify-content: center; transition: all 0.2s; flex-shrink: 0;
    }
    .btn-photo:hover { background: rgba(212,165,116,0.2); }
    #msg-input {
      flex: 1; padding: 11px 16px; border-radius: 14px;
      border: 1.5px solid rgba(168,144,120,0.2);
      background: rgba(255,255,255,0.8); font-size: 14.5px; color: #4A3C32;
      outline: none; transition: border-color 0.2s; min-width: 0;
    }
    #msg-input:focus { border-color: rgba(212,165,116,0.5); }
    #msg-input::placeholder { color: #B8A596; }
    .btn-send {
      width: 40px; height: 40px; border-radius: 12px; border: none;
      background: rgba(212,165,116,0.15); cursor: pointer; font-size: 16px;
      display: flex; align-items: center; justify-content: center;
      transition: all 0.2s; color: #C4A882; flex-shrink: 0;
    }
    .btn-send.active {
      background: linear-gradient(135deg, #D4A574, #C4956A);
      color: #fff; box-shadow: 0 3px 10px rgba(196,149,106,0.3);
    }

    /* Welcome / no chat selected */
    #welcome-screen {
      flex: 1; display: flex; flex-direction: column;
      align-items: center; justify-content: center; gap: 14px; padding: 40px;
    }
    .welcome-logo {
      width: 90px; height: 90px; border-radius: 28px;
      background: linear-gradient(135deg, #D4A574, #C4956A, #B8845A);
      display: flex; align-items: center; justify-content: center;
      font-size: 44px; box-shadow: 0 10px 40px rgba(196,149,106,0.25);
      animation: float 3s ease-in-out infinite;
    }
    .welcome-title { font-size: 22px; font-weight: 700; color: #5C4A3A; }
    .welcome-text { font-size: 14px; color: #A08B78; text-align: center; max-width: 280px; line-height: 1.6; }

    /* Image lightbox */
    #lightbox {
      position: fixed; inset: 0; z-index: 100; background: rgba(0,0,0,0.85);
      display: none; align-items: center; justify-content: center; cursor: pointer;
    }
    #lightbox.visible { display: flex; }
    #lightbox img { max-width: 92%; max-height: 92%; border-radius: 8px; object-fit: contain; }

    /* Loading spinner */
    .spinner {
      width: 32px; height: 32px; border: 3px solid rgba(212,165,116,0.2);
      border-top-color: #D4A574; border-radius: 50%;
      animation: spin 0.7s linear infinite; margin: 20px auto;
    }

    /* ===== ANIMATIONS ===== */
    @keyframes cardAppear { from { opacity: 0; transform: translateY(16px) scale(0.97); } to { opacity: 1; transform: none; } }
    @keyframes msgPop { from { opacity: 0; transform: translateY(6px); } to { opacity: 1; transform: none; } }
    @keyframes float { 0%,100% { transform: translateY(0); } 50% { transform: translateY(-6px); } }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* ===== SCROLLBAR ===== */
    ::-webkit-scrollbar { width: 4px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: rgba(168,144,120,0.2); border-radius: 4px; }

    /* ===== MOBILE ===== */
    @media (max-width: 700px) {
      #sidebar { width: 100%; min-width: 100%; }
      #sidebar.chat-open { display: none; }
      #chat-area { display: none; }
      #chat-area.chat-open { display: flex; }
      .btn-back { display: flex; }
    }
  </style>
</head>
<body>

<div id="bg-pattern"></div>

<!-- ===== LOGIN SCREEN ===== -->
<div id="login-screen" class="screen">
  <div class="login-card">
    <div class="login-logo">üè†</div>
    <div class="login-title">–ù–∞—à–∞ –°–µ–º—å—è</div>
    <div class="login-subtitle">–í–æ–π–¥–∏—Ç–µ –≤ —Å–µ–º–µ–π–Ω—ã–π –º–µ—Å—Å–µ–Ω–¥–∂–µ—Ä</div>
    <div id="login-error" class="error-msg hidden"></div>
    <input id="login-email" class="form-input" type="email" placeholder="Email" autocomplete="email">
    <input id="login-password" class="form-input" type="password" placeholder="–ü–∞—Ä–æ–ª—å" autocomplete="current-password">
    <button id="login-btn" class="btn-primary" onclick="handleLogin()">–í–æ–π—Ç–∏</button>
  </div>
</div>

<!-- ===== PROFILE SETUP SCREEN ===== -->
<div id="setup-screen" class="screen hidden">
  <div class="login-card" style="max-width: 420px;">
    <div class="login-logo">‚ú®</div>
    <div class="login-title">–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!</div>
    <div class="login-subtitle">–ù–∞—Å—Ç—Ä–æ–π—Ç–µ —Å–≤–æ–π –ø—Ä–æ—Ñ–∏–ª—å</div>
    <input id="setup-name" class="form-input" type="text" placeholder="–í–∞—à–µ –∏–º—è (–∫–∞–∫ –≤–∏–¥—è—Ç —Ä–æ–¥–Ω—ã–µ)">
    <div class="section-label">–í–∞—à –∞–≤–∞—Ç–∞—Ä</div>
    <div class="emoji-grid" id="emoji-grid"></div>
    <div class="section-label">–¶–≤–µ—Ç –ø—Ä–æ—Ñ–∏–ª—è</div>
    <div class="color-grid" id="color-grid"></div>
    <input id="setup-city" class="form-input" type="text" placeholder="–ì–æ—Ä–æ–¥ (–Ω–∞–ø—Ä–∏–º–µ—Ä: –õ–æ–Ω–¥–æ–Ω)">
    <button id="setup-btn" class="btn-primary" onclick="handleSetup()">–ù–∞—á–∞—Ç—å –æ–±—â–µ–Ω–∏–µ</button>
  </div>
</div>

<!-- ===== MESSENGER SCREEN ===== -->
<div id="messenger-screen" class="screen hidden">
  <!-- Sidebar -->
  <div id="sidebar">
    <div class="sidebar-header">
      <div class="sidebar-logo">üè†</div>
      <div>
        <div class="sidebar-title">–ù–∞—à–∞ –°–µ–º—å—è</div>
        <div class="sidebar-meta" id="sidebar-meta"></div>
      </div>
    </div>
    <!-- Notification prompt banner -->
    <div id="notification-banner" class="notification-banner hidden">
      <span>üîî</span>
      <span>–í–∫–ª—é—á–∏—Ç–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</span>
      <button onclick="requestNotificationPermission()">–í–∫–ª—é—á–∏—Ç—å</button>
      <button class="dismiss" onclick="dismissNotificationBanner()">‚úï</button>
    </div>
    <div id="conv-list"></div>
    <div class="sidebar-footer" id="sidebar-footer"></div>
  </div>

  <!-- Chat Area -->
  <div id="chat-area">
    <div id="welcome-screen">
      <div class="welcome-logo">üè†</div>
      <div class="welcome-title">–ù–∞—à–∞ –°–µ–º—å—è</div>
      <div class="welcome-text">–í—ã–±–µ—Ä–∏—Ç–µ –±–µ—Å–µ–¥—É —Å–ª–µ–≤–∞, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å –æ–±—â–µ–Ω–∏–µ —Å –±–ª–∏–∑–∫–∏–º–∏ ‚ù§Ô∏è</div>
    </div>
  </div>
</div>

<!-- Lightbox for images -->
<div id="lightbox" onclick="closeLightbox()">
  <img id="lightbox-img" src="" alt="">
</div>

<!-- Hidden file input -->
<input type="file" id="file-input" accept="image/*" style="display:none" onchange="handleFileSelect(event)">

<script>
// =============================================
// ‚öôÔ∏è CONFIGURATION ‚Äî –ó–ê–ú–ï–ù–ò–¢–ï –ù–ê –°–í–û–ò –î–ê–ù–ù–´–ï
// =============================================
const SUPABASE_URL = 'https://elrmeqivmjtzqkqfyigv.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVscm1lcWl2bWp0enFrcWZ5aWd2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzEwMDM3OTIsImV4cCI6MjA4NjU3OTc5Mn0.SZqK8n-yuNR6rsSdQuW2-whGdi9njgnknJpn84Kfa7Q';

// üîî VAPID Public Key for Push Notifications
const VAPID_PUBLIC_KEY = 'BLyAuZAxQJY4nSD0YRm3LB66TWuhTWmTlO4qV4AxIfy2AXSFnUMdZXFXZOly2U11hoLZbRL2HmAbnNq5BpRyN8E';

// =============================================
// üóÉÔ∏è STATE
// =============================================
let sb; // supabase client
let state = {
  user: null,
  profile: null,
  profiles: {},
  conversations: [],
  activeConv: null,
  messages: [],
  channel: null,
  pushSubscription: null,
};

const EMOJIS = ['üòä','üòé','ü§ó','üòÑ','ü•∞','ü§ì','üë©','üë®','üëß','üßë','üëµ','üë¥','üë∂','üßî','üíÉ','üï∫'];
const COLORS = ['#E8B4B8','#A7C7E7','#C3B1E1','#B5D8CC','#F0D9B5','#F4A6A0','#A8D8EA','#C5E1A5','#FFCC80','#CE93D8'];
let selectedEmoji = 'üòä';
let selectedColor = '#A7C7E7';
let pendingPhoto = null;

// =============================================
// üöÄ INITIALIZATION
// =============================================
async function init() {
  const { createClient } = supabase;
  sb = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  await registerServiceWorker();

  const { data: { session } } = await sb.auth.getSession();
  if (session) {
    state.user = session.user;
    await loadProfile();
  } else {
    showScreen('login');
  }

  sb.auth.onAuthStateChange(async (event, session) => {
    if (event === 'SIGNED_IN' && session) {
      state.user = session.user;
      await loadProfile();
    } else if (event === 'SIGNED_OUT') {
      state.user = null;
      state.profile = null;
      showScreen('login');
    }
  });
}

// =============================================
// üîî PUSH NOTIFICATIONS
// =============================================
async function registerServiceWorker() {
  if (!('serviceWorker' in navigator)) return;
  try {
    const registration = await navigator.serviceWorker.register('/sw.js');
    console.log('Service Worker registered:', registration.scope);
  } catch (error) {
    console.error('Service Worker registration failed:', error);
  }
}

function showNotificationBanner() {
  if (!('Notification' in window) || !('serviceWorker' in navigator)) return;
  if (Notification.permission === 'granted') return;
  if (Notification.permission === 'denied') return;
  if (localStorage.getItem('notification-dismissed')) return;
  document.getElementById('notification-banner').classList.remove('hidden');
}

function dismissNotificationBanner() {
  document.getElementById('notification-banner').classList.add('hidden');
  localStorage.setItem('notification-dismissed', 'true');
}

async function requestNotificationPermission() {
  try {
    const permission = await Notification.requestPermission();
    if (permission === 'granted') {
      await subscribeToPush();
      document.getElementById('notification-banner').classList.add('hidden');
    } else {
      dismissNotificationBanner();
    }
  } catch (error) {
    console.error('Error requesting notification permission:', error);
  }
}

async function subscribeToPush() {
  try {
    const registration = await navigator.serviceWorker.ready;
    let subscription = await registration.pushManager.getSubscription();
    
    if (!subscription) {
      subscription = await registration.pushManager.subscribe({
        userVisibleOnly: true,
        applicationServerKey: urlBase64ToUint8Array(VAPID_PUBLIC_KEY)
      });
    }

    state.pushSubscription = subscription;
    await savePushSubscription(subscription);
    console.log('Push subscription successful');
  } catch (error) {
    console.error('Push subscription failed:', error);
  }
}

async function savePushSubscription(subscription) {
  const subscriptionJson = subscription.toJSON();
  const { error } = await sb.from('push_subscriptions').upsert({
    profile_id: state.user.id,
    endpoint: subscriptionJson.endpoint,
    p256dh: subscriptionJson.keys.p256dh,
    auth: subscriptionJson.keys.auth,
  }, { onConflict: 'profile_id,endpoint' });

  if (error) console.error('Error saving push subscription:', error);
}

function urlBase64ToUint8Array(base64String) {
  const padding = '='.repeat((4 - base64String.length % 4) % 4);
  const base64 = (base64String + padding).replace(/-/g, '+').replace(/_/g, '/');
  const rawData = window.atob(base64);
  const outputArray = new Uint8Array(rawData.length);
  for (let i = 0; i < rawData.length; ++i) {
    outputArray[i] = rawData.charCodeAt(i);
  }
  return outputArray;
}

async function checkExistingPermission() {
  if (Notification.permission === 'granted') {
    await subscribeToPush();
  } else if (Notification.permission === 'default') {
    showNotificationBanner();
  }
}

// =============================================
// üîê AUTH
// =============================================
async function handleLogin() {
  const email = document.getElementById('login-email').value.trim();
  const password = document.getElementById('login-password').value;
  const errorEl = document.getElementById('login-error');
  const btn = document.getElementById('login-btn');

  if (!email || !password) {
    errorEl.textContent = '–í–≤–µ–¥–∏—Ç–µ email –∏ –ø–∞—Ä–æ–ª—å';
    errorEl.classList.remove('hidden');
    return;
  }

  btn.disabled = true;
  btn.textContent = '–í—Ö–æ–¥–∏–º...';
  errorEl.classList.add('hidden');

  const { error } = await sb.auth.signInWithPassword({ email, password });

  if (error) {
    errorEl.textContent = '–ù–µ–≤–µ—Ä–Ω—ã–π email –∏–ª–∏ –ø–∞—Ä–æ–ª—å';
    errorEl.classList.remove('hidden');
    btn.disabled = false;
    btn.textContent = '–í–æ–π—Ç–∏';
  }
}

async function handleLogout() {
  if (state.channel) {
    sb.removeChannel(state.channel);
    state.channel = null;
  }
  await sb.auth.signOut();
}

// =============================================
// üë§ PROFILE
// =============================================
async function loadProfile() {
  const { data: profile } = await sb.from('profiles').select('*').eq('id', state.user.id).single();

  if (profile) {
    state.profile = profile;
    await enterMessenger();
  } else {
    showScreen('setup');
    renderEmojiGrid();
    renderColorGrid();
  }
}

async function handleSetup() {
  const name = document.getElementById('setup-name').value.trim();
  const city = document.getElementById('setup-city').value.trim();

  if (!name) { alert('–í–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ –∏–º—è'); return; }

  const btn = document.getElementById('setup-btn');
  btn.disabled = true;
  btn.textContent = '–°–æ–∑–¥–∞—ë–º –ø—Ä–æ—Ñ–∏–ª—å...';

  const { data, error } = await sb.from('profiles').insert({
    id: state.user.id,
    display_name: name,
    emoji: selectedEmoji,
    color: selectedColor,
    city: city || 'üåç',
  }).select().single();

  if (error) {
    alert('–û—à–∏–±–∫–∞: ' + error.message);
    btn.disabled = false;
    btn.textContent = '–ù–∞—á–∞—Ç—å –æ–±—â–µ–Ω–∏–µ';
    return;
  }

  state.profile = data;
  await enterMessenger();
}

function renderEmojiGrid() {
  const grid = document.getElementById('emoji-grid');
  grid.innerHTML = EMOJIS.map(e =>
    `<div class="emoji-option ${e === selectedEmoji ? 'selected' : ''}" onclick="selectEmoji('${e}', this)">${e}</div>`
  ).join('');
}

function selectEmoji(emoji, el) {
  selectedEmoji = emoji;
  document.querySelectorAll('.emoji-option').forEach(e => e.classList.remove('selected'));
  el.classList.add('selected');
}

function renderColorGrid() {
  const grid = document.getElementById('color-grid');
  grid.innerHTML = COLORS.map(c =>
    `<div class="color-option ${c === selectedColor ? 'selected' : ''}" style="background:${c}" onclick="selectColor('${c}', this)"></div>`
  ).join('');
}

function selectColor(color, el) {
  selectedColor = color;
  document.querySelectorAll('.color-option').forEach(e => e.classList.remove('selected'));
  el.classList.add('selected');
}

// =============================================
// üí¨ MESSENGER ENTRY
// =============================================
async function enterMessenger() {
  showScreen('messenger');
  await loadAllProfiles();
  await loadConversations();
  renderSidebar();
  await checkExistingPermission();
}

async function loadAllProfiles() {
  const { data } = await sb.from('profiles').select('*');
  state.profiles = {};
  (data || []).forEach(p => { state.profiles[p.id] = p; });
}

// =============================================
// üìã CONVERSATIONS
// =============================================
async function loadConversations() {
  const { data: memberships } = await sb.from('conversation_members')
    .select('conversation_id').eq('profile_id', state.user.id);

  if (!memberships || memberships.length === 0) { state.conversations = []; return; }

  const convIds = memberships.map(m => m.conversation_id);

  const { data: convs } = await sb.from('conversations')
    .select('*').in('id', convIds).order('created_at');

  for (const conv of (convs || [])) {
    const { data: members } = await sb.from('conversation_members')
      .select('profile_id').eq('conversation_id', conv.id);
    conv.members = (members || []).map(m => m.profile_id);

    const { data: lastMsg } = await sb.from('messages')
      .select('*').eq('conversation_id', conv.id)
      .order('created_at', { ascending: false }).limit(1);
    conv.lastMessage = lastMsg?.[0] || null;
  }

  state.conversations = (convs || []).sort((a, b) => {
    if (a.is_group && !b.is_group) return -1;
    if (!a.is_group && b.is_group) return 1;
    const timeA = a.lastMessage?.created_at || a.created_at;
    const timeB = b.lastMessage?.created_at || b.created_at;
    return new Date(timeB) - new Date(timeA);
  });
}

async function openConversation(convId) {
  state.activeConv = convId;

  document.querySelectorAll('.conv-item').forEach(el => el.classList.remove('active'));
  const activeEl = document.querySelector(`[data-conv="${convId}"]`);
  if (activeEl) activeEl.classList.add('active');

  document.getElementById('sidebar').classList.add('chat-open');
  document.getElementById('chat-area').classList.add('chat-open');

  await loadMessages(convId);
  renderChatArea();
  subscribeToMessages(convId);
  scrollToBottom();
}

function goBack() {
  state.activeConv = null;
  document.getElementById('sidebar').classList.remove('chat-open');
  document.getElementById('chat-area').classList.remove('chat-open');
}

async function openDM(otherUserId) {
  const existing = state.conversations.find(c =>
    !c.is_group && c.members.length === 2 &&
    c.members.includes(state.user.id) && c.members.includes(otherUserId)
  );

  if (existing) {
    openConversation(existing.id);
    return;
  }

  const { data: conv } = await sb.from('conversations').insert({ is_group: false }).select().single();
  if (!conv) return;

  await sb.from('conversation_members').insert([
    { conversation_id: conv.id, profile_id: state.user.id },
    { conversation_id: conv.id, profile_id: otherUserId },
  ]);

  await loadConversations();
  renderSidebar();
  openConversation(conv.id);
}

// =============================================
// üì® MESSAGES
// =============================================
async function loadMessages(convId) {
  const { data } = await sb.from('messages')
    .select('*').eq('conversation_id', convId)
    .order('created_at', { ascending: true })
    .limit(200);

  state.messages = data || [];
}

function subscribeToMessages(convId) {
  if (state.channel) {
    sb.removeChannel(state.channel);
    state.channel = null;
  }

  state.channel = sb.channel(`conv-${convId}`)
    .on('postgres_changes', {
      event: 'INSERT',
      schema: 'public',
      table: 'messages',
      filter: `conversation_id=eq.${convId}`,
    }, (payload) => {
      const newMsg = payload.new;
      if (!state.messages.find(m => m.id === newMsg.id)) {
        state.messages.push(newMsg);
        appendMessage(newMsg);
        scrollToBottom();
        updateConvLastMessage(convId, newMsg);
      }
    })
    .subscribe((status) => {
      console.log('Realtime status:', status);
    });
}

// üîÑ REFRESH CHAT - –∫–Ω–æ–ø–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
function refreshChat() {
  location.reload();
}

async function sendMessage() {
  const input = document.getElementById('msg-input');
  const text = input.value.trim();

  if (!text && !pendingPhoto) return;

  let imageUrl = null;

  if (pendingPhoto) {
    const file = pendingPhoto;
    const ext = file.name.split('.').pop();
    const path = `${state.activeConv}/${Date.now()}.${ext}`;

    const { data, error } = await sb.storage.from('photos').upload(path, file);
    if (error) {
      alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–æ—Ç–æ: ' + error.message);
      return;
    }

    const { data: { publicUrl } } = sb.storage.from('photos').getPublicUrl(path);
    imageUrl = publicUrl;
    clearPhotoPreview();
  }

  const { error } = await sb.from('messages').insert({
    conversation_id: state.activeConv,
    sender_id: state.user.id,
    content: text,
    image_url: imageUrl,
  });

  if (error) {
    alert('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏: ' + error.message);
    return;
  }

  input.value = '';
  updateSendButton();
}

// =============================================
// üì∏ PHOTO HANDLING
// =============================================
function handleFileSelect(event) {
  const file = event.target.files?.[0];
  if (!file) return;

  pendingPhoto = file;
  const reader = new FileReader();
  reader.onload = (e) => {
    const preview = document.getElementById('photo-preview');
    preview.querySelector('img').src = e.target.result;
    preview.classList.add('visible');
    updateSendButton();
  };
  reader.readAsDataURL(file);
  event.target.value = '';
}

function clearPhotoPreview() {
  pendingPhoto = null;
  const preview = document.getElementById('photo-preview');
  preview.classList.remove('visible');
  updateSendButton();
}

function openLightbox(src) {
  document.getElementById('lightbox-img').src = src;
  document.getElementById('lightbox').classList.add('visible');
}

function closeLightbox() {
  document.getElementById('lightbox').classList.remove('visible');
}

// =============================================
// üé® UI RENDERING
// =============================================
function showScreen(name) {
  document.getElementById('login-screen').classList.toggle('hidden', name !== 'login');
  document.getElementById('setup-screen').classList.toggle('hidden', name !== 'setup');
  document.getElementById('messenger-screen').classList.toggle('hidden', name !== 'messenger');
}

function renderSidebar() {
  const profileCount = Object.keys(state.profiles).length;
  const cities = [...new Set(Object.values(state.profiles).map(p => p.city).filter(Boolean))];
  document.getElementById('sidebar-meta').textContent =
    `${profileCount} —É—á–∞—Å—Ç–Ω–∏–∫${getPlural(profileCount)} ‚Ä¢ ${cities.length} ${cities.length === 1 ? '–≥–æ—Ä–æ–¥' : '–≥–æ—Ä–æ–¥–æ–≤'}`;

  const list = document.getElementById('conv-list');
  let html = '';

  const groups = state.conversations.filter(c => c.is_group);
  if (groups.length) {
    html += '<div class="conv-section-title">–°–µ–º–µ–π–Ω—ã–π —á–∞—Ç</div>';
    groups.forEach(c => { html += renderConvItem(c); });
  }

  const dms = state.conversations.filter(c => !c.is_group);
  const otherProfiles = Object.values(state.profiles).filter(p => p.id !== state.user.id);

  if (otherProfiles.length) {
    html += '<div class="conv-section-title">–õ–∏—á–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è</div>';
    otherProfiles.forEach(p => {
      const dm = dms.find(c => c.members.includes(p.id));
      if (dm) {
        html += renderConvItem(dm, p);
      } else {
        html += `
          <div class="conv-item" onclick="openDM('${p.id}')">
            <div class="conv-avatar" style="background: linear-gradient(145deg, ${p.color}, ${p.color}dd)">${p.emoji}</div>
            <div class="conv-info">
              <div class="conv-name">${esc(p.display_name)}</div>
              <div class="conv-last-msg" style="color: #C4A882; font-style: italic;">–ù–∞—á–∞—Ç—å –±–µ—Å–µ–¥—É...</div>
              <div class="conv-city"><span class="online-dot"></span> ${esc(p.city)}</div>
            </div>
          </div>`;
      }
    });
  }

  list.innerHTML = html;

  if (state.activeConv) {
    const el = document.querySelector(`[data-conv="${state.activeConv}"]`);
    if (el) el.classList.add('active');
  }

  const p = state.profile;
  document.getElementById('sidebar-footer').innerHTML = `
    <div class="my-avatar" style="background: linear-gradient(145deg, ${p.color}, ${p.color}dd)">${p.emoji}</div>
    <div>
      <div class="my-name">${esc(p.display_name)}</div>
      <div class="my-city">${esc(p.city)}</div>
    </div>
    <button class="btn-logout" onclick="handleLogout()">–í—ã–π—Ç–∏</button>
  `;
}

function renderConvItem(conv, dmPartner) {
  let name, emoji, color, city, avatar;

  if (conv.is_group) {
    name = conv.name || '–ì—Ä—É–ø–ø–∞';
    emoji = 'üë®‚Äçüë©‚Äçüëß‚Äçüë¶';
    color = '#D4A574';
    city = '';
    avatar = `<div class="conv-avatar" style="background: linear-gradient(145deg, ${color}, ${color}dd)">${emoji}</div>`;
  } else {
    const partner = dmPartner || (() => {
      const otherId = conv.members.find(m => m !== state.user.id);
      return state.profiles[otherId];
    })();
    if (!partner) return '';
    name = partner.display_name;
    emoji = partner.emoji;
    color = partner.color;
    city = partner.city;
    avatar = `<div class="conv-avatar" style="background: linear-gradient(145deg, ${color}, ${color}dd)">${emoji}</div>`;
  }

  const lastMsg = conv.lastMessage;
  let lastText = '';
  let lastTime = '';
  if (lastMsg) {
    const sender = state.profiles[lastMsg.sender_id];
    const senderName = lastMsg.sender_id === state.user.id ? '–í—ã' : (sender?.display_name || '');
    if (lastMsg.image_url && !lastMsg.content) {
      lastText = `${senderName}: üì∑ –§–æ—Ç–æ`;
    } else {
      lastText = `${senderName}: ${lastMsg.content || ''}`;
    }
    if (lastText.length > 40) lastText = lastText.substring(0, 40) + '...';
    lastTime = formatTime(lastMsg.created_at);
  }

  return `
    <div class="conv-item" data-conv="${conv.id}" onclick="openConversation('${conv.id}')">
      ${avatar}
      <div class="conv-info">
        <div style="display:flex; justify-content:space-between; align-items:center;">
          <div class="conv-name">${esc(name)}</div>
          <div class="conv-time">${lastTime}</div>
        </div>
        <div class="conv-last-msg">${esc(lastText)}</div>
        ${city ? `<div class="conv-city"><span class="online-dot"></span> ${esc(city)}</div>` : ''}
      </div>
    </div>`;
}

function renderChatArea() {
  const conv = state.conversations.find(c => c.id === state.activeConv);
  if (!conv) return;

  let headerName, headerEmoji, headerColor, headerStatus;

  if (conv.is_group) {
    headerName = conv.name || '–ì—Ä—É–ø–ø–∞';
    headerEmoji = 'üë®‚Äçüë©‚Äçüëß‚Äçüë¶';
    headerColor = '#D4A574';
    const memberNames = conv.members
      .map(id => state.profiles[id]?.display_name)
      .filter(Boolean).join(', ');
    headerStatus = `<div class="chat-header-members">${esc(memberNames)}</div>`;
  } else {
    const otherId = conv.members.find(m => m !== state.user.id);
    const partner = state.profiles[otherId];
    if (!partner) return;
    headerName = partner.display_name;
    headerEmoji = partner.emoji;
    headerColor = partner.color;
    headerStatus = `<div class="chat-header-status"><span class="online-dot"></span> ${esc(partner.city)}</div>`;
  }

  const chatArea = document.getElementById('chat-area');
  chatArea.innerHTML = `
    <div class="chat-header">
      <button class="btn-back" onclick="goBack()">‚Üê</button>
      <div class="chat-header-avatar" style="background: linear-gradient(145deg, ${headerColor}, ${headerColor}dd)">${headerEmoji}</div>
      <div style="flex:1">
        <div class="chat-header-name">${esc(headerName)}</div>
        ${headerStatus}
      </div>
      <button class="btn-refresh" onclick="refreshChat()" title="–û–±–Ω–æ–≤–∏—Ç—å">üîÑ</button>
    </div>
    <div id="messages-container"></div>
    <div id="photo-preview">
      <img src="" alt="preview">
      <button class="btn-remove-photo" onclick="clearPhotoPreview()">‚úï –£–±—Ä–∞—Ç—å</button>
    </div>
    <div class="chat-input-area">
      <button class="btn-photo" onclick="document.getElementById('file-input').click()">üì∑</button>
      <input id="msg-input" type="text" placeholder="–ù–∞–ø–∏—Å–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ..."
             oninput="updateSendButton()" onkeydown="if(event.key==='Enter')sendMessage()">
      <button class="btn-send" id="btn-send" onclick="sendMessage()">‚û§</button>
    </div>
  `;

  const container = document.getElementById('messages-container');
  let lastDate = '';
  state.messages.forEach(msg => {
    const date = formatDate(msg.created_at);
    if (date !== lastDate) {
      container.innerHTML += `<div class="msg-date-divider">${date}</div>`;
      lastDate = date;
    }
    container.innerHTML += renderMessage(msg, conv.is_group);
  });
}

function renderMessage(msg, isGroup) {
  const isMe = msg.sender_id === state.user.id;
  const sender = state.profiles[msg.sender_id];
  const senderName = sender?.display_name || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π';

  let content = '';
  if (isGroup && !isMe) {
    content += `<div class="msg-sender" style="color: ${sender?.color || '#999'}">${esc(senderName)}</div>`;
  }
  if (msg.image_url) {
    content += `<img class="msg-image" src="${esc(msg.image_url)}" alt="–§–æ—Ç–æ" onclick="openLightbox('${esc(msg.image_url)}')" loading="lazy">`;
  }
  if (msg.content) {
    content += `<div class="msg-text">${esc(msg.content)}</div>`;
  }
  content += `<div class="msg-time">${formatTime(msg.created_at)}</div>`;

  return `<div class="msg-row ${isMe ? 'me' : 'other'}"><div class="msg-bubble">${content}</div></div>`;
}

function appendMessage(msg) {
  const container = document.getElementById('messages-container');
  if (!container) return;

  const conv = state.conversations.find(c => c.id === state.activeConv);
  const isGroup = conv?.is_group || false;

  const date = formatDate(msg.created_at);
  const lastDateEl = container.querySelector('.msg-date-divider:last-of-type');
  if (!lastDateEl || lastDateEl.textContent !== date) {
    container.insertAdjacentHTML('beforeend', `<div class="msg-date-divider">${date}</div>`);
  }

  container.insertAdjacentHTML('beforeend', renderMessage(msg, isGroup));
}

function updateConvLastMessage(convId, msg) {
  const conv = state.conversations.find(c => c.id === convId);
  if (conv) conv.lastMessage = msg;
  renderSidebar();
}

function updateSendButton() {
  const input = document.getElementById('msg-input');
  const btn = document.getElementById('btn-send');
  if (!input || !btn) return;
  const hasContent = input.value.trim() || pendingPhoto;
  btn.classList.toggle('active', !!hasContent);
}

function scrollToBottom() {
  requestAnimationFrame(() => {
    const container = document.getElementById('messages-container');
    if (container) container.scrollTop = container.scrollHeight;
  });
}

// =============================================
// üõ†Ô∏è HELPERS
// =============================================
function esc(str) {
  if (!str) return '';
  const div = document.createElement('div');
  div.textContent = str;
  return div.innerHTML;
}

function formatTime(dateStr) {
  if (!dateStr) return '';
  const d = new Date(dateStr);
  return d.toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' });
}

function formatDate(dateStr) {
  if (!dateStr) return '';
  const d = new Date(dateStr);
  const today = new Date();
  const yesterday = new Date(today);
  yesterday.setDate(yesterday.getDate() - 1);

  if (d.toDateString() === today.toDateString()) return '–°–µ–≥–æ–¥–Ω—è';
  if (d.toDateString() === yesterday.toDateString()) return '–í—á–µ—Ä–∞';
  return d.toLocaleDateString('ru-RU', { day: 'numeric', month: 'long' });
}

function getPlural(n) {
  if (n % 10 === 1 && n % 100 !== 11) return '';
  if ([2,3,4].includes(n % 10) && ![12,13,14].includes(n % 100)) return '–∞';
  return '–æ–≤';
}

document.addEventListener('keydown', (e) => {
  if (e.key === 'Enter') {
    if (!document.getElementById('login-screen').classList.contains('hidden')) {
      handleLogin();
    }
  }
});

// =============================================
// üèÅ START
// =============================================
init();
</script>
</body>
</html>
